<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>KKWay</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/app.css" rel="stylesheet">
    <script src="qr/qr-scanner.min.js"></script>
</head>

<body>

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <a class="navbar-brand" href="index.html">KKWAY</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault"
            aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="index.html">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="help.html">Help</a>
                </li>
            </ul>
        </div>
    </nav>

    <main role="main" class="container">

        <div class="main-area">
            <h1>KKWay</h1>
            <p class="lead">Have trouble finding your destination? Scan the nearest QR code and find your way there!</p>
            <input class="form-control form-control-lg" type="text" placeholder="Destination Unit Number">
        </div>

        <div class="cam-area">
            <video muted autoplay playsinline id="qr-video"></video>
            <h2>Detected QR code: <span id="cam-qr-result">None</span></h2>
        </div>

    </main>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script>
        window.jQuery || document.write('<script src="js/vendor/jquery-slim.min.js"><\/script>')
    </script>
    <script src="js/vendor/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script type="module">
        import QrScanner from "./qr/qr-scanner.min.js";
        const video = document.getElementById('qr-video');
        const debugCheckbox = document.getElementById('debug-checkbox');
        const debugCanvas = document.getElementById('debug-canvas');
        const debugCanvasContext = debugCanvas.getContext('2d');
        const camQrResult = document.getElementById('cam-qr-result');
        const fileSelector = document.getElementById('file-selector');
        const fileQrResult = document.getElementById('file-qr-result');

        function setResult(label, result) {
            label.textContent = result;
            label.style.color = 'teal';
            clearTimeout(label.highlightTimeout);
            label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
        }


        // ####### Web Cam Scanning #######

        const scanner = new QrScanner(video, result => setResult(camQrResult, result), 240);
        scanner.start();


        // ####### File Scanning #######

        fileSelector.addEventListener('change', event => {
            const file = fileSelector.files[0];
            if (!file) {
                return;
            }
            QrScanner.scanImage(file)
                .then(result => setResult(fileQrResult, result))
                .catch(e => setResult(fileQrResult, e || 'No QR code found.'));
        });


        // ####### debug mode related code #######

        debugCheckbox.addEventListener('change', () => setDebugMode(debugCheckbox.checked));

        function setDebugMode(isDebug) {
            const worker = scanner._qrWorker;
            worker.postMessage({
                type: 'setDebug',
                data: isDebug
            });
            if (isDebug) {
                debugCanvas.style.display = 'block';
                worker.addEventListener('message', handleDebugImage);
            } else {
                debugCanvas.style.display = 'none';
                worker.removeEventListener('message', handleDebugImage);
            }
        }

        function handleDebugImage(event) {
            const type = event.data.type;
            if (type === 'debugImage') {
                const imageData = event.data.data;
                if (debugCanvas.width !== imageData.width || debugCanvas.height !== imageData.height) {
                    debugCanvas.width = imageData.width;
                    debugCanvas.height = imageData.height;
                }
                debugCanvasContext.putImageData(imageData, 0, 0);
            }
        }
    </script>
</body>

</html>